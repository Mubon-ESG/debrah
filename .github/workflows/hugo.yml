name: Deploy Hugo site to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: latest
          extended: true

      - name: Find disableKinds/outputs in repo
        run: |
          echo "===== config files ====="
          find . -maxdepth 4 -type f \( -iname "hugo.toml" -o -iname "config.toml" -o -iname "config.yaml" -o -iname "config.yml" -o -iname "config.json" \) -print
          echo "===== grep disableKinds/outputs (excluding themes) ====="
          grep -RIn --exclude-dir=.git --exclude-dir=themes -E "disableKinds|\\[outputs\\]|outputs[[:space:]]*=|paginate[[:space:]]*=" . || true

      - name: Inspect PaperMod layouts
        run: |
          echo "===== themes/PaperMod exists? ====="
          ls -la themes || true
          ls -la themes/PaperMod || true
          echo "===== list themes/PaperMod/layouts files (top 80) ====="
          find themes/PaperMod/layouts -maxdepth 3 -type f -print | head -n 80 || true
          echo "===== must-have templates ====="
          ls -la themes/PaperMod/layouts/index.html || true
          ls -la themes/PaperMod/layouts/_default/list.html || true
          ls -la themes/PaperMod/layouts/_default/single.html || true
          ls -la themes/PaperMod/layouts/_default/baseof.html || true

      - name: Build (capture full log even on failure)
        run: |
          set +e
          hugo version
          rm -rf public
          mkdir -p /tmp

          echo "===== hugo.toml (first 220 lines) =====" | tee /tmp/hugo_build.log
          (nl -ba hugo.toml | sed -n '1,220p') 2>&1 | tee -a /tmp/hugo_build.log

          echo "===== content files =====" | tee -a /tmp/hugo_build.log
          (find content -maxdepth 5 -type f -print) 2>&1 | tee -a /tmp/hugo_build.log

          echo "===== hugo build output =====" | tee -a /tmp/hugo_build.log
          hugo --minify --config hugo.toml --baseURL "https://mubon-esg.github.io/Debrah/" --destination public --buildDrafts --buildFuture 2>&1 | tee -a /tmp/hugo_build.log
          HUGO_EXIT=${PIPESTATUS[0]}

          echo "===== public root =====" | tee -a /tmp/hugo_build.log
          (ls -la public || true) 2>&1 | tee -a /tmp/hugo_build.log

          echo "===== html files =====" | tee -a /tmp/hugo_build.log
          (find public -maxdepth 5 -type f -name "*.html" -print || true) 2>&1 | tee -a /tmp/hugo_build.log

          echo "===== LAST 200 LINES (the real error is here) ====="
          tail -n 200 /tmp/hugo_build.log

          exit $HUGO_EXIT

      - name: Upload hugo build log artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: hugo_build_log
          path: /tmp/hugo_build.log

      - name: Upload Pages artifact
        if: success()
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: success()
    environment:
      name: github-pages
    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4



